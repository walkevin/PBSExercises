%%% Using tdplotsetmaincoords{-20}{-40} with the option rotate=-40 is not good practice. It's a workaround.
%%% Be aware that here the order of coordinates is z,x,y with x,y,z being the expected behaviour.
%%% This is not nice but I don't know how to tell gnuplot to make a plot outside the xy-plane.
%%% One option would be a ``raw'' gnuplot inside a tikz-environment.
%%% Anyway it looks exactly the same. The code is just ugly because of that.


%%% I hope these tikz-commands are understandable even with a lack of documentation.
%%% If you have questions, just ask.

\tdplotsetmaincoords{-20}{-40}
%\tdplotsetmaincoords{70}{110}
\begin{tikzpicture}[tdplot_main_coords,rotate=-40]
		\node[align=center,anchor=north] (boa) at (0,-1em) {beam\\of atoms};
	\begin{scope}[shift={(2,0.5)},scale=0.5]
				\draw[fill=helsinkimorning] (0,3,1) -- (0,1,1) -- (4,1,1) -- (4,3,1) -- cycle;
				\draw[fill=helsinkimorning] (0,1,1) -- (0,0,0) -- (4,0,0) -- (4,1,1) -- cycle; 
				\draw[fill=helsinkimorning] (4,0,0) -- (4,1,-1) -- (4,3,-1) -- (4,3,1) -- (4,1,1) -- cycle; 
				\draw[fill=helsinkimorning] (0,3,1) -- (4,3,1) -- (4,3,-1) -- (0,3,-1) -- cycle;
				\node[white] (nul) at (2,2,1) {$N$};
				\foreach \x in {0,...,4}
					\coordinate[] (n\x) at (\x,0,0);
	\end{scope}
	\begin{scope}[shift={(2,-0.5)},scale=0.5]
		\draw[fill=rioday] (0,0,1) -- (4,0,1) -- (4,0,-1) -- (0,0,-1) -- cycle;
		\draw[fill=rioday] (0,0,1) -- (0,-3,1) -- (4,-3,1) -- (4,0,1) -- cycle;
		\draw[fill=rioday] (4,0,1) -- (4,-3,1) -- (4,-3,-1) -- (4,0,-1) -- cycle;
		\node[] (nll) at (2,-1.5,1) {$S$};
		\foreach \x in {0,...,4}
			\coordinate[] (s\x) at (\x,0,0);
	\end{scope}
	\foreach \x in {0.5,0.475,...,-0.5}
	{
		\draw[domain=2:4.25,very thin,black!20] plot[parametric,id=test\x] function{t,\x/10+\x*(t-2)**2/10};
	}
	\foreach \x in {0.5,0.475,...,-0.5}
	{
		\draw[domain=2:6.5,very thin] plot[parametric,id=test\x] function{t,\x/10+\x*(t-2)**2/10};
		\draw[domain=-1:2,very thin] plot[parametric,id=test\x] function{t,\x/10};
	}
	\foreach \x in {0,...,4}
	\draw[black!50,-latex,decoration={snake,post=lineto,post length=2mm},decorate] (n\x) -- (s\x);
	\node[align=center,anchor=south east] (imf) at (1.5,1) {inhomogeneous\\magnetic field};
	\draw[-latex] (imf.south) -- (1.8,0.25,0);
	\path[] (6.5,2.5,1) -- (6.5,-2.5,1) coordinate[label=below:screen] (screen);
	\draw[zyplane=6.5] (-1,-2.5) rectangle (1,2.5);
\end{tikzpicture}

